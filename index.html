<!DOCTYPE html>
<html>
  <head>
    <title>Link Tracking Demo</title>
  </head>
  <body>
    <h2>Link Tracking Demo</h2>
    <a href="https://contoh.com" onclick="handleClick(event, this.href)"
      >Klik untuk Kunjungi Contoh.com</a
    >

    <script>
      const GOOGLE_SHEET_URL =
        "https://script.google.com/macros/s/AKfycbzgsn8JaBr9NUYovJuEDQ_25HAVuoEgNQmVMyJrxakotq0RfkBlkic4XUACCOp2qK8dpg/exec"; // Ganti dengan Web App URL dari Google Apps Script
      const OPENCAGE_API_KEY = "ab4b8f2bf41e49b08925612ba526d0d5"; // Ganti dengan API Key OpenCage yang valid

      async function handleClick(event, link) {
        event.preventDefault();

        let lat = null;
        let lng = null;
        let address = "Geolocation tidak tersedia";

        // Coba dapatkan lokasi
        if (navigator.geolocation) {
          try {
            const position = await new Promise((resolve, reject) => {
              navigator.geolocation.getCurrentPosition(resolve, reject, {
                timeout: 10000,
                maximumAge: 0,
              });
            });
            lat = position.coords.latitude;
            lng = position.coords.longitude;
            address = await getAddress(lat, lng);
          } catch (error) {
            console.error("Geolocation error:", error.message);
            address = "Gagal mendapatkan lokasi: " + error.message;
          }
        } else {
          console.warn("Geolocation tidak didukung oleh browser.");
        }

        // Kirim data ke Google Sheets
        try {
          await sendData(link, lat, lng, address);
          console.log("Data berhasil dikirim");
        } catch (error) {
          console.error("Gagal mengirim data:", error.message);
          alert("Gagal mengirim data: " + error.message);
        }

        // Arahkan ke link tujuan
        window.location.href = link;
      }

      async function getAddress(lat, lng) {
        try {
          const response = await fetch(
            `https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lng}&key=${OPENCAGE_API_KEY}`
          );
          if (!response.ok) {
            throw new Error(`OpenCage API error: ${response.status}`);
          }
          const data = await response.json();
          return data.results && data.results.length > 0
            ? data.results[0].formatted
            : "Alamat tidak ditemukan";
        } catch (error) {
          console.error("Gagal reverse geocoding:", error.message);
          return "Gagal mendapatkan alamat: " + error.message;
        }
      }

      async function sendData(link, lat, lng, address) {
        const data = {
          timestamp: new Date().toISOString(),
          link: link,
          userAgent: navigator.userAgent,
          latitude: lat || "N/A",
          longitude: lng || "N/A",
          address: address || "N/A",
        };

        const response = await fetch(GOOGLE_SHEET_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          throw new Error(`Gagal mengirim data: ${response.status}`);
        }

        const result = await response.json();
        if (result.status !== "success") {
          throw new Error(result.message || "Gagal menyimpan data di server");
        }
        return result;
      }
    </script>
  </body>
</html>
